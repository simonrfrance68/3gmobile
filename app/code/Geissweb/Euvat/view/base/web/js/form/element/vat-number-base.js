/**
 * ||GEISSWEB| EU VAT Enhanced
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the GEISSWEB End User License Agreement
 * that is available through the world-wide-web at this URL: https://www.geissweb.de/legal-information/eula
 *
 * DISCLAIMER
 *
 * Do not edit this file if you wish to update the extension in the future. If you wish to customize the extension
 * for your needs please refer to our support for more information.
 *
 * @package     Geissweb_Euvat
 * @copyright   Copyright (c) 2015-2019 GEISS WeblÃ¶sungen (https://www.geissweb.de)
 * @license     https://www.geissweb.de/legal-information/eula GEISSWEB End User License Agreement
 */

define([
    'jquery',
    'Magento_Ui/js/form/element/abstract',
    'ko',
    'Magento_Ui/js/lib/validation/validator',
    'mage/url',
    'mageUtils',
    'mage/translate',
    'uiRegistry',
    'Magento_Ui/js/modal/confirm'
], function ($, Abstract, ko, validator, url, Utils, $t, registry, confirm) {
    'use strict';

    return Abstract.extend({

        defaults: {
            label: $t('VAT Number'),
            template: 'Geissweb_Euvat/vatfield',
            elementTmpl: 'Geissweb_Euvat/vat-input',
            classes: null,
            containerClasses: null,
            countryCode: '',
            allowedCountries: false,
            enableAjaxValidation: false,
            taxCalcMethod: 'shipping',
            isValidated: ko.observable(false),
            isValidVatNumber: ko.observable(false),
            validatedNumber: ko.observable(),
            success: ko.observable(false),
            response: ko.observable(),
            successForId: ko.observable(),
            required: ko.observable(),
            passedRegex: ko.observable(false),
            debug: false,
            isChanging: false,
            isOutOfUiScope: false,
            isImport: false,
            isAdminhtml: false,
            vatFrontendVisibility: false,
            placeholder: '',
            retry: false,
            retryText: $t('Click here to try again.'),
            validVatRequiredMessage: $t('Please type a valid VAT number in this field. Example: CC123456789'),
            validVatIfSpecifiedMessage: $t('Please type a valid VAT number in this field, or leave it empty.'),
            delay: 3000,
            askCustomerCountryCorrection: false,
            timeout: null,
            baseURL: ''
        },

        /**
         * Init; Toggle visibility depending on config
         * @param options
         * @returns {exports}
         */
        initialize: function (options) {
            this._super();
            this.successId = 'success-'+this.uid;
            this.initObservable();
            if (this.debug) {
                console.log('vatNumberBase options', options);
                console.log('vatNumberBase init', this);
            }

            if (this.baseURL.length > 0) {
                url.setBaseUrl(this.baseURL);
            }

            if (this.vatFrontendVisibility === false) {
                this.visible(false);
            } else {
                this.setVisibility(this.getCountry());
            }

            return this;
        },

        /**
         * Initializes observable properties of instance
         *
         * @returns {Abstract} Chainable.
         */
        initObservable: function () {
            this._super();
            this.observe('isValidated isValidVatNumber success');
            return this;
        },

        /**
         * Sets initial visibility
         * @param countryValue
         */
        setVisibility: function (countryValue) {
            if (this.debug) {
                console.log("got value from country select: "+countryValue);
            }
            if (this.vatFrontendVisibility === true
                && $.isArray(this.allowedCountries)
                && $.inArray(countryValue, this.allowedCountries) !== -1
            ) {
                this.visible(true);
            } else {
                this.value('');
                this.visible(false);
            }
        },

        /**
         * Save country prefix from VAT number
         * @param value
         */
        setVatNumberCountry: function (value) {
            if (this.debug) {
                console.log("setting VAT number country prefix: "+value);
            }
            this.countryCode = value;
        },

        /**
         * Check if number can be validated and validate it, show messages accordingly
         * @returns {*}
         */
        validate: function () {
            this.clearMessages();
            var value   = this.value();
            var countryCode = this.getCountry();
            var isValid = false;
            var message;

            if (this.debug) {
                console.log("base validate() "+countryCode);
            }

            //syntax check first to lower request count to services
            if (this.isChanging && !Utils.isEmpty(value)) {

                if (value.match(new RegExp('^[A-Z][A-Z]'))) {
                    if (this.debug) {
                        console.log("base validate, got countrycode");
                    }
                    countryCode = value.substr(0,2).toUpperCase();
                    this.setVatNumberCountry(countryCode);
                } else {
                    if (!Utils.isEmpty(countryCode)) {
                        if(countryCode === 'GR') {
                            value = 'EL'+value;
                        } else {
                            value = countryCode+value;
                        }
                        this.value(value);
                        if (this.debug) {
                            console.log("base validate, using new value: "+value);
                        }

                    } else {
                        message = $t('Please provide the country code prefix of the VAT number.');
                        if (!this.isOutOfUiScope) {
                            this.source.set('params.invalid', true);
                        }
                        if (this.isAdminhtml) {
                            this.error(message);
                            this.bubble('error', message);
                        } else {
                            this.warn(message);
                            this.bubble('warn', message);
                        }
                    }
                }

                if (typeof(this.patterns[countryCode]) !== 'undefined') {
                    if (this.debug) {
                        console.log("using pattern "+this.patterns[countryCode]);
                    }
                    var regex = new RegExp(this.patterns[countryCode]);
                    if (regex.test(value)) {
                        this.passedRegex(true);

                        if (!this.isAdminhtml) {
                            $('input[name='+this.inputName+']').blur();
                        }
                        // AJAX validation
                        if (this.enableAjaxValidation === true) {
                            var deferred = $.Deferred();
                            this.beforeValidation(deferred);
                            return this.validateVatNumber(value);
                        }

                    } else {
                        this.passedRegex(false);
                        if (this.debug) {
                            console.log("base validate, format invalid");
                        }
                        isValid = false;
                        message = $t('The format of the VAT number is invalid for this country.');
                        if (!this.isOutOfUiScope) {
                            this.source.set('params.invalid', true);
                        }
                        if (this.isAdminhtml) {
                            this.error(message);
                            this.bubble('error', message);
                        } else {
                            this.warn(message);
                            this.bubble('warn', message);
                        }
                    }

                } else {
                    if (this.debug) {
                        console.log("base validate, no EU number");
                    }
                    isValid = false;
                    this.passedRegex(false);
                    this.error($t('This does not seem to be a EU VAT Number.'));
                    this.bubble('error', message);
                    if (!this.isOutOfUiScope) {
                        this.source.set('params.invalid', true);
                    }
                }

            }

            //regular validation
            var result  = validator(this.validation, value, this.validationParams);
            message = result.message;
            isValid = result.passed;
            this.error(message);
            this.bubble('error', message);
            if (this.debug) {
                console.log("base validate, regular validation result", result);
            }
            if (!isValid && !this.isOutOfUiScope) {
                this.source.set('params.invalid', true);
            }
            return {
                valid: isValid,
                target: this
            };
        },

        /**
         * Unset all messages
         */
        clearMessages: function () {
            this.success(false);
            this.warn('');
            this.error('');
            this.bubble('success');
            this.bubble('warn');
            this.bubble('error');
        },

        /**
         * Control validation execution
         * @param value
         */
        onUpdate: function (value) {
            if (this.debug) {
                console.log("base onUpdate("+value+")");
                console.log(value);
            }

            if (this.timeout !== null) {
                if (this.debug) {
                    console.log("Clearing timeout "+this.timeout);
                }
                clearTimeout(this.timeout);
            }

            this.clearMessages();
            this.isValidated(false);
            this.isValidVatNumber(false);
            var deferred = $.Deferred();
            var self = this;

            if (!Utils.isEmpty(value)
                && value.length > 3
                && !this.isChanging
                && !this.isImport
            ) {
                this.timeout = setTimeout(function () {
                    value = value.replace(/[\W_]/g, "").toUpperCase().trim();
                    self.isChanging = true;
                    self.value(value);
                    self.bubble('update', self.hasChanged());
                    self.validate();
                    self.isChanging = false;
                    self.isImport = false;
                }, this.delay);

                if (this.debug) {
                    console.log("Added timeout with "+this.delay+"ms delay: "+this.timeout);
                }

            } else if (Utils.isEmpty(value) && !this.isChanging) {
                this.isChanging = true;
                this.value(''); // really need to set null - but causes bug in FF
                this.isChanging = false;
                this.beforeValidation(deferred);
                this.afterValidation(deferred);
            }
        },

        /**
         * AJAX validation of the VAT number
         * @param vatNumber
         */
        validateVatNumber: function (vatNumber) {
            if (this.debug) {
                console.log("base validateVatNumber("+vatNumber+")");
            }
            $('body').trigger('processStart');

            var self = this;
            var valid = false;
            var formKey;
            self.isValidated(false);

            if (typeof(window.FORM_KEY) !== 'undefined' && window.FORM_KEY.length > 0) {
                formKey = window.FORM_KEY;
            } else if (!this.isAdminhtml && (typeof($.cookie) === 'function' && $.cookie('form_key').length > 0)) {
                formKey = $.cookie('form_key');
            }

            $.ajax({
                type: 'POST',
                url: url.build('euvat/vatnumber/validation/'),
                data: {
                    vat_number: vatNumber,
                    form_key: formKey,
                    handle: self.handle
                },

                success: function (response) {
                    self.clearMessages();
                    self.response(response);
                    self.isValidated(true);
                    self.validatedNumber(vatNumber);

                    if (response.vat_is_valid === true) {
                        valid = true;
                        self.isValidVatNumber(true);
                        self.success($t(response.request_message));
                        self.successForId(self.successId);

                    } else {
                        valid = false;
                        self.isValidVatNumber(false);
                        if (response.warning === true) {
                            self.retry = true;
                            self.warn($t(response.request_message));
                        } else {
                            self.error($t(response.request_message));
                        }
                    }
                },

                error: function (response) {
                    valid = false;
                    self.isValidated(false);
                    self.isValidVatNumber(false);
                    self.response(response);

                    self.retry = true;
                    self.warn($t('Error during VAT number validation request.'));
                },

                always: function () {
                    $('body').trigger('processStop');
                }

            }).then(function (data, textStatus, jqXHR) {
                self.afterValidation(jqXHR);
            }).done(function () {
                self.isValidated(true);
                $('body').trigger('processStop');
                return {
                    valid: valid,
                    target: self
                };
            });

        },

        /**
         * Is implemented in specific instances of this
         */
        beforeValidation: function () {
        },
        /**
         * Is implemented in specific instances of this
         */
        afterValidation: function (jqXHR) {
        },

        /**
         * Try to check false country selections
         * @param {String} value
         * @param deferred
         */
        updateCountry: function (value, deferred) {
            if (this.debug) {
                console.log("base updateCountry("+value+")");
                console.log("base fetching "+this.parentName + '.' + 'country_id');
            }
            deferred = deferred || $.Deferred();
            var country = registry.get(this.parentName + '.' + 'country_id');

            if (!value
                || !this.askCustomerCountryCorrection
                || this.parentScope !== 'shippingAddress'
                || typeof(country) !== 'object'
                || Utils.isEmpty(country.value())
                || $.inArray(value, this.allowedCountries) === -1
            ) {
                deferred.resolve();
                return deferred.promise();
            }

            if (value === 'EL') {
                value = 'GR';
            }

            if (value !== country.value()) {
                var self = this;
                confirm({
                    title: $t('VAT number validation result'),
                    content: $t('The country prefix of your VAT Number does not match your address country. Shall we automatically set the country?'),
                    actions: {
                        confirm: function () {
                            country.value(value);
                        },
                        cancel: function () {
                            self.countryCode = '';
                            self.value('');
                            self.clearMessages();
                        },
                        always: function () {
                            deferred.resolve();
                        }
                    }
                });
            } else {
                deferred.resolve();
            }

            return deferred.promise();
        },

        countryEvent: function () {
            if (this.debug) {
                console.log("base countryEvent()");
            }
            var country = registry.get(this.parentName + '.' + 'country_id');
            if (typeof(country) !== 'object' || Utils.isEmpty(country.value())) {
                return;
            }
            country.value(country.value());
        },

        getCountry: function () {
            var country = registry.get(this.parentName + '.' + 'country_id');
            if (typeof(country) !== 'object' || Utils.isEmpty(country.value())) {
                return false;
            }
            if (this.debug) {
                console.log("base getCountry(): "+country.value());
            }
            return country.value();
        },

        getRegion: function () {
            var region = registry.get(this.parentName + '.' + 'region_id');
            if (typeof(region) !== 'object' || Utils.isEmpty(region.value())) {
                return false;
            }
            if (this.debug) {
                console.log("base getRegion(): "+region.value());
            }
            return region.value();
        },

        ///AJAX validation of the VAT number
        checkCached: function (vatNumber) {
            if (this.debug) {
                console.log("base checkCached()");
            }
            $('body').trigger('processStart');

            var self = this;
            var valid = false;
            var formKey;
            self.isValidated(false);

            if (typeof(window.FORM_KEY) !== 'undefined' && window.FORM_KEY.length > 0) {
                formKey = window.FORM_KEY;
            } else if (!this.isAdminhtml && (typeof($.cookie) === 'function' && $.cookie('form_key').length > 0)) {
                formKey = $.cookie('form_key');
            }

            $.ajax({
                type: 'POST',
                url: url.build('euvat/vatnumber/cached'),
                data: {
                    vat_number: vatNumber,
                    form_key: formKey,
                    handle: self.handle
                },

                success: function (response) {
                    self.clearMessages();
                    self.response(response);
                    self.isValidated(true);

                    if (response.vat_is_valid === true) {
                        valid = true;
                        self.isValidVatNumber(true);
                        //self.success($t(response.request_message));
                        self.successForId(self.successId);

                    } else {
                        valid = false;
                        self.isValidVatNumber(false);
                        if (response.warning === true) {
                            self.retry = true;
                            self.warn($t(response.request_message));
                        } else {
                            self.error($t(response.request_message));
                        }
                    }
                },

                error: function (response) {
                    valid = false;
                    self.isValidated(false);
                    self.isValidVatNumber(false);
                    self.response(response);

                    self.retry = true;
                    self.warn($t('Error during VAT number validation request.'));
                }

            }).done(function () {
                $('body').trigger('processStop');
                return {
                    valid: valid,
                    target: self
                };
            });

        },

        lockValidation: function (message) {
            this.disable();
            $('span#vatid-tooltip').removeClass('field-tooltip-action').addClass('vatvalidation-success');
            $('span#vatid-reset').show();
            this.tooltip.description($t(message));
        },

        retryValidation: function () {
            return this.onUpdate(this.value());
        },

        _ruleValidVat: function (value) {
            var errMsg = this.error();
            if (typeof errMsg === 'undefined') {
                errMsg = '';
            }
            if (this.debug) {
                console.log('base _ruleValidVat');
                console.log("errMsg: "+errMsg);
                console.log("this.isValidated(): "+this.isValidated());
                console.log("this.isValidVatNumber(): "+this.isValidVatNumber());
                console.log("EnableAJAX: "+this.enableAjaxValidation);
                console.log("Regex passed: "+this.passedRegex());
            }
            if (this.visible()) {
                //if(this.getCountry() === 'ES' && this.getRegion() !== '') {
                //    console.log("ES Region: "+this.getRegion());
                //}
                if (!this.enableAjaxValidation && this.passedRegex()) {
                    if (this.debug) {
                        console.log("OFFLINE Validation");
                    }
                    return true;
                }
                return this.isValidated() && this.isValidVatNumber() && (errMsg.length <= 0);

            } else {
                return true;
            }

        },

        _ruleValidVatIfSpecified: function (value) {
            if (this.visible() && typeof(value) === 'string' && value.length > 0) {
                var errMsg = this.error();
                if (typeof errMsg === 'undefined') {
                    errMsg = '';
                }
                if (this.debug) {
                    console.log('base _ruleValidVatIfSpecified');
                    console.log("errMsg: "+errMsg);
                    console.log("this.isValidated(): "+this.isValidated());
                    console.log("this.isValidVatNumber(): "+this.isValidVatNumber());
                }
                if (!this.enableAjaxValidation && this.passedRegex()) {
                    if (this.debug) {
                        console.log("OFFLINE Validation");
                    }
                    return true;
                }
                return this.isValidated() && this.isValidVatNumber() && (errMsg.length <= 0);
            }
            if (this.debug) {
                console.log('base _ruleValidVatIfSpecified (no value)');
            }
            return true;
        },

        patterns:
        {
            'AT' : '(AT)U[0-9]{8}$',
            'BE' : '(BE)0[0-9]{9}$',
            'BG' : '(BG)[0-9]{9,10}$',
            'CY' : '(CY)[0-9]{8}[A-Z]$',
            'CZ' : '(CZ)[0-9]{8,10}$',
            'DE' : '(DE)[0-9]{9}$',
            'DK' : '(DK)[0-9]{8}$',
            'EE' : '(EE)[0-9]{9}$',
            'GR' : '(EL|GR)[0-9]{9}$',
            'EL' : '(EL|GR)[0-9]{9}$',
            'ES' : '(ES)[0-9A-Z][0-9]{7}[0-9A-Z]$',
            'FI' : '(FI)[0-9]{8}$',
            'FR' : '(FR)[0-9A-Z]{2}[0-9]{9}$',
            'GB' : '(GB)([0-9]{9}([0-9]{3})?|[A-Z]{2}[0-9]{3}$)',
            'HR' : '(HR)[0-9]{11}$',
            'HU' : '(HU)[0-9]{8}$',
            'IE' : '(IE)(([0-9]{7}WI|[0-9][0-9A-Z\*\+][0-9]{5}[A-Z]{1,2}$))',
            'IT' : '(IT)[0-9]{11}$',
            'LT' : '(LT)([0-9]{9}|[0-9]{12}$)',
            'LU' : '(LU)[0-9]{8}$',
            'LV' : '(LV)[0-9]{11}$',
            'MT' : '(MT)[0-9]{8}$',
            'NL' : '(NL)[0-9]{9}B[0-9]{2}$',
            'PL' : '(PL)[0-9]{10}$',
            'PT' : '(PT)[0-9]{9}$',
            'RO' : '(RO)[0-9]{2,10}$',
            'SE' : '(SE)[0-9]{12}$',
            'SI' : '(SI)[0-9]{8}$',
            'SK' : '(SK)[0-9]{10}$'
        }

    });
});