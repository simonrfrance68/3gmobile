/**
 * ||GEISSWEB| EU VAT Enhanced
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the GEISSWEB End User License Agreement
 * that is available through the world-wide-web at this URL: https://www.geissweb.de/legal-information/eula
 *
 * DISCLAIMER
 *
 * Do not edit this file if you wish to update the extension in the future. If you wish to customize the extension
 * for your needs please refer to our support for more information.
 *
 * @package     Geissweb_Euvat
 * @copyright   Copyright (c) 2015-2019 GEISS WeblÃ¶sungen (https://www.geissweb.de)
 * @license     https://www.geissweb.de/legal-information/eula GEISSWEB End User License Agreement
 */

define([
    'jquery',
    'Geissweb_Euvat/js/form/element/vat-number-co',
    'Geissweb_Euvat/js/queue',
    'uiRegistry',
    'mageUtils',
    'mage/translate',
    'Magento_Ui/js/lib/validation/validator',
    'Magento_Ui/js/modal/confirm',
    'Magento_Checkout/js/model/shipping-service',
    'Magento_Checkout/js/model/shipping-rates-validator'
], function (
    $,
    VatNumberCo,
    queue,
    registry,
    Utils,
    $t,
    validator,
    confirm,
    shippingService,
    shippingRatesValidator
) {
    'use strict';

    return VatNumberCo.extend({

        defaults: {
            debug: false
        },

        initialize: function () {
            this.element = this._super();
            this.initObservable().setCssClasses();
            var self = this;

            validator.addRule('valid-vat-required', function (value) {
                return self._ruleValidVat(value);
            }, this.validVatRequiredMessage);

            validator.addRule('valid-vat-if-specified', function (value) {
                return self._ruleValidVatIfSpecified(value);
            }, this.validVatIfSpecifiedMessage);

            for (var property in this.validation) {
                if (this.validation.hasOwnProperty(property)
                    && property === 'valid-vat-required'
                ) {
                    _.extend(this.additionalClasses, {
                        _required: true
                    });
                }
            }

            if (this.customScope === 'shippingAddress') {
                this.countrySelect = registry.get('checkout.shippingAddress.shipping-address-fieldset.country-region-zip-field-row.country_id');
            } else {
                this.countrySelect = registry.get('checkout.paymentMethod.billingAddress.billing-address-fieldset.country-region-zip-field-row.country_id');
            }

            if (this.vatFrontendVisibility === false) {
                this.visible(false);
            } else {
                this.setVisibility(this.getCountry());
            }

            shippingRatesValidator.bindHandler(this.element, null);

            return this;
        },

        afterValidation: function (jqXHR) {
            if (this.debug) {
                console.log("aw afterValidation");
            }
            if (this.countryCode.length > 0) {
                var self = this;
                queue.addFunction(function () {
                    return self.updateCountry(self.countryCode, jqXHR);
                })
            }

            queue.addFunction(function () {
                $('body').trigger('processStop');
            });

            return queue.run();
        },

        /**
         * Get country value from select
         * @returns {string}
         */
        getCountry: function () {
            if (typeof(this.countrySelect) !== 'object' || Utils.isEmpty(this.countrySelect.value())) {
                return '';
            }
            if (this.debug) {
                console.log("aw getCountry: "+this.countrySelect.value());
            }
            return this.countrySelect.value();
        },

        /**
         * Set country value for select
         * @param value
         * @returns {boolean}
         */
        setCountry: function (value) {
            if (typeof(this.countrySelect) !== 'object' || Utils.isEmpty(value)) {
                return false;
            }
            if (this.debug) {
                console.log("aw setCountry: "+value);
            }
            this.countrySelect.value(value);
            return true;
        },

        /**
         * @param {String} value
         * @param deferred
         */
        updateCountry: function (value, deferred) {
            var country = this.getCountry();
            if (this.debug) {
                console.log("aw updateCountry()");
                console.log("value:"+value);
                console.log("country:"+country);
            }

            if (!value
                || !this.askCustomerCountryCorrection
                || Utils.isEmpty(country)
                || $.inArray(value, this.allowedCountries) === -1
            ) {
                if (this.debug) {
                    console.log("updateCountry abort!");
                }
                return deferred.promise();
            }

            if (value === 'EL') {
                value = 'GR';
            }

            if (value !== country) {
                var self = this;
                confirm({
                    title: $t('VAT number validation result'),
                    content: $t('The country prefix of your VAT Number does not match your address country. Shall we automatically set the country?'),
                    actions: {
                        confirm: function () {
                            self.setCountry(value);
                        },
                        cancel: function () {
                            self.countryCode = '';
                            self.value('');
                            self.clearMessages();
                        },
                        always: function () {
                            $('body').trigger('processStop');
                        }
                    }
                });
            }

        }

    });
});